import{a as x,b as K}from"./chunk-COHAZZTS.js";import{a as W}from"./chunk-QRWHQ7IS.js";import{a as A,c as U}from"./chunk-2B6HUC56.js";var pe=U(a=>{var i=W(),q=A("url"),$=A("buffer"),B=A("http"),N=K(),G=x();function T(e){return new Promise((t,o)=>{let r=B.request({method:"GET",...e,hostname:e.hostname?.replace(/^\[(.+)\]$/,"$1")});r.on("error",n=>{o(Object.assign(new i.ProviderError("Unable to connect to instance metadata service"),n)),r.destroy()}),r.on("timeout",()=>{o(new i.ProviderError("TimeoutError from instance metadata service")),r.destroy()}),r.on("response",n=>{let{statusCode:s=400}=n;(s<200||300<=s)&&(o(Object.assign(new i.ProviderError("Error response received from instance metadata service"),{statusCode:s})),r.destroy());let f=[];n.on("data",c=>{f.push(c)}),n.on("end",()=>{t($.Buffer.concat(f)),r.destroy()})}),r.end()})}var M=e=>!!e&&typeof e=="object"&&typeof e.AccessKeyId=="string"&&typeof e.SecretAccessKey=="string"&&typeof e.Token=="string"&&typeof e.Expiration=="string",y=e=>({accessKeyId:e.AccessKeyId,secretAccessKey:e.SecretAccessKey,sessionToken:e.Token,expiration:new Date(e.Expiration),...e.AccountId&&{accountId:e.AccountId}}),R=1e3,b=0,w=({maxRetries:e=b,timeout:t=R})=>({maxRetries:e,timeout:t}),g=(e,t)=>{let o=e();for(let r=0;r<t;r++)o=o.catch(e);return o},m="AWS_CONTAINER_CREDENTIALS_FULL_URI",v="AWS_CONTAINER_CREDENTIALS_RELATIVE_URI",h="AWS_CONTAINER_AUTHORIZATION_TOKEN",H=(e={})=>{let{timeout:t,maxRetries:o}=w(e);return()=>g(async()=>{let r=await Y({logger:e.logger}),n=JSON.parse(await j(t,r));if(!M(n))throw new i.CredentialsProviderError("Invalid response received from instance metadata service.",{logger:e.logger});return y(n)},o)},j=async(e,t)=>(process.env[h]&&(t.headers={...t.headers,Authorization:process.env[h]}),(await T({...t,timeout:e})).toString()),z="169.254.170.2",J={localhost:!0,"127.0.0.1":!0},X={"http:":!0,"https:":!0},Y=async({logger:e})=>{if(process.env[v])return{hostname:z,path:process.env[v]};if(process.env[m]){let t=q.parse(process.env[m]);if(!t.hostname||!(t.hostname in J))throw new i.CredentialsProviderError(`${t.hostname} is not a valid container metadata service hostname`,{tryNextLink:!1,logger:e});if(!t.protocol||!(t.protocol in X))throw new i.CredentialsProviderError(`${t.protocol} is not a valid container metadata service protocol`,{tryNextLink:!1,logger:e});return{...t,port:t.port?parseInt(t.port,10):void 0}}throw new i.CredentialsProviderError(`The container metadata credential provider cannot be used unless the ${v} or ${m} environment variable is set`,{tryNextLink:!1,logger:e})},C=class e extends i.CredentialsProviderError{tryNextLink;name="InstanceMetadataV1FallbackError";constructor(t,o=!0){super(t,o),this.tryNextLink=o,Object.setPrototypeOf(this,e.prototype)}};a.Endpoint=void 0;(function(e){e.IPv4="http://169.254.169.254",e.IPv6="http://[fd00:ec2::254]"})(a.Endpoint||(a.Endpoint={}));var Z="AWS_EC2_METADATA_SERVICE_ENDPOINT",Q="ec2_metadata_service_endpoint",ee={environmentVariableSelector:e=>e[Z],configFileSelector:e=>e[Q],default:void 0},I;(function(e){e.IPv4="IPv4",e.IPv6="IPv6"})(I||(I={}));var te="AWS_EC2_METADATA_SERVICE_ENDPOINT_MODE",re="ec2_metadata_service_endpoint_mode",ne={environmentVariableSelector:e=>e[te],configFileSelector:e=>e[re],default:I.IPv4},L=async()=>G.parseUrl(await oe()||await ae()),oe=async()=>N.loadConfig(ee)(),ae=async()=>{let e=await N.loadConfig(ne)();switch(e){case I.IPv4:return a.Endpoint.IPv4;case I.IPv6:return a.Endpoint.IPv6;default:throw new Error(`Unsupported endpoint mode: ${e}. Select from ${Object.values(I)}`)}},se=300,ie=300,ce="https://docs.aws.amazon.com/sdkref/latest/guide/feature-static-credentials.html",D=(e,t)=>{let o=se+Math.floor(Math.random()*ie),r=new Date(Date.now()+o*1e3);t.warn(`Attempting credential expiration extension due to a credential service availability issue. A refresh of these credentials will be attempted after ${new Date(r)}.
For more information, please visit: `+ce);let n=e.originalExpiration??e.expiration;return{...e,...n?{originalExpiration:n}:{},expiration:r}},de=(e,t={})=>{let o=t?.logger||console,r;return async()=>{let n;try{n=await e(),n.expiration&&n.expiration.getTime()<Date.now()&&(n=D(n,o))}catch(s){if(r)o.warn("Credential renew failed: ",s),n=D(r,o);else throw s}return r=n,n}},F="/latest/meta-data/iam/security-credentials/",le="/latest/api/token",S="AWS_EC2_METADATA_V1_DISABLED",O="ec2_metadata_v1_disabled",P="x-aws-ec2-metadata-token",Ee=(e={})=>de(fe(e),{logger:e.logger}),fe=(e={})=>{let t=!1,{logger:o,profile:r}=e,{timeout:n,maxRetries:s}=w(e),f=async(c,_)=>{if(t||_.headers?.[P]==null){let d=!1,l=!1,k=await N.loadConfig({environmentVariableSelector:E=>{let u=E[S];if(l=!!u&&u!=="false",u===void 0)throw new i.CredentialsProviderError(`${S} not set in env, checking config file next.`,{logger:e.logger});return l},configFileSelector:E=>{let u=E[O];return d=!!u&&u!=="false",d},default:!1},{profile:r})();if(e.ec2MetadataV1Disabled||k){let E=[];throw e.ec2MetadataV1Disabled&&E.push("credential provider initialization (runtime option ec2MetadataV1Disabled)"),d&&E.push(`config file profile (${O})`),l&&E.push(`process environment variable (${S})`),new C(`AWS EC2 Metadata v1 fallback has been blocked by AWS SDK configuration in the following: [${E.join(", ")}].`)}}let V=(await g(async()=>{let d;try{d=await ue(_)}catch(l){throw l.statusCode===401&&(t=!1),l}return d},c)).trim();return g(async()=>{let d;try{d=await Ie(V,_,e)}catch(l){throw l.statusCode===401&&(t=!1),l}return d},c)};return async()=>{let c=await L();if(t)return o?.debug("AWS SDK Instance Metadata","using v1 fallback (no token fetch)"),f(s,{...c,timeout:n});{let _;try{_=(await _e({...c,timeout:n})).toString()}catch(p){if(p?.statusCode===400)throw Object.assign(p,{message:"EC2 Metadata token request returned error"});return(p.message==="TimeoutError"||[403,404,405].includes(p.statusCode))&&(t=!0),o?.debug("AWS SDK Instance Metadata","using v1 fallback (initial)"),f(s,{...c,timeout:n})}return f(s,{...c,headers:{[P]:_},timeout:n})}}},_e=async e=>T({...e,path:le,method:"PUT",headers:{"x-aws-ec2-metadata-token-ttl-seconds":"21600"}}),ue=async e=>(await T({...e,path:F})).toString(),Ie=async(e,t,o)=>{let r=JSON.parse((await T({...t,path:F+e})).toString());if(!M(r))throw new i.CredentialsProviderError("Invalid response received from instance metadata service.",{logger:o.logger});return y(r)};a.DEFAULT_MAX_RETRIES=b;a.DEFAULT_TIMEOUT=R;a.ENV_CMDS_AUTH_TOKEN=h;a.ENV_CMDS_FULL_URI=m;a.ENV_CMDS_RELATIVE_URI=v;a.fromContainerMetadata=H;a.fromInstanceMetadata=Ee;a.getInstanceMetadataEndpoint=L;a.httpRequest=T;a.providerConfigFromInit=w});export{pe as a};
//# sourceMappingURL=chunk-NQ5PH7UV.js.map
